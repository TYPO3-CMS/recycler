/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import E from"@typo3/core/document-service.js";import"@typo3/backend/element/progress-bar-element.js";import"@typo3/backend/element/alert-element.js";import"@typo3/backend/element/icon-element.js";import"@typo3/backend/element/pagination.js";import T from"@typo3/backend/action-button/deferred-action.js";import f from"@typo3/backend/modal.js";import P from"@typo3/backend/notification.js";import{SeverityEnum as S}from"@typo3/backend/enum/severity.js";import m from"@typo3/core/event/regular-event.js";import x from"@typo3/core/ajax/ajax-request.js";import R from"~labels/core.common";import i from"~labels/recycler.messages";var s;(function(d){d.searchForm="#recycler-form",d.searchText="#recycler-form [name=search-text]",d.searchSubmitBtn="#recycler-form button[type=submit]",d.depthSelector="#recycler-form [name=depth]",d.tableSelector="#recycler-form [name=pages]",d.recyclerTable="#itemsInRecycler",d.paginator="#recycler-index nav",d.reloadAction="a[data-action=reload]",d.undo="button[data-action=undo]",d.delete="button[data-action=delete]",d.massUndo="button[data-multi-record-selection-action=massundo]",d.massDelete="button[data-multi-record-selection-action=massdelete]"})(s||(s={}));class v{constructor(){this.paging={currentPage:1,totalPages:1,totalItems:0,itemsPerPage:parseInt(TYPO3.settings.Recycler.pagingSize,10)},this.markedRecordsForMassAction=[],this.progressBar=null,E.ready().then(()=>{this.initialize()})}static refreshPageTree(){top.document.dispatchEvent(new CustomEvent("typo3:pagetree:refresh"))}getProgress(){return(!this.progressBar||!this.progressBar.isConnected)&&(this.progressBar=document.createElement("typo3-backend-progress-bar"),document.querySelector(s.recyclerTable).prepend(this.progressBar)),this.progressBar}registerEvents(){new m("submit",t=>{t.preventDefault(),document.querySelector(s.searchText).value!==""&&this.loadDeletedElements()}).delegateTo(document,s.searchForm),new m("input",(t,e)=>{const l=document.querySelector(s.searchSubmitBtn);e.value!==""?l.disabled=!1:(l.disabled=!0,this.loadDeletedElements())}).delegateTo(document,s.searchText),new m("change",()=>{this.loadAvailableTables().then(()=>{this.loadDeletedElements()})}).delegateTo(document,s.depthSelector),new m("change",()=>{this.paging.currentPage=1,this.loadDeletedElements()}).delegateTo(document,s.tableSelector),new m("click",this.undoRecord.bind(this)).delegateTo(document,s.undo),new m("click",this.deleteRecord.bind(this)).delegateTo(document,s.delete),new m("click",t=>{t.preventDefault(),this.loadAvailableTables().then(()=>{this.loadDeletedElements()})}).delegateTo(document,s.reloadAction),new m("search",(t,e)=>{if(e.value===""){const l=document.querySelector(s.searchSubmitBtn);l.disabled=!0,this.loadDeletedElements()}}).delegateTo(document,s.searchText),new m("click",t=>{t.preventDefault();const e=t.target.closest("button");e&&(e.dataset.action==="previous"?this.paging.currentPage>1&&this.paging.currentPage--:e.dataset.action==="next"?this.paging.currentPage<this.paging.totalPages&&this.paging.currentPage++:e.dataset.action==="page"&&(this.paging.currentPage=parseInt(e.querySelector("span").textContent,10)),this.loadDeletedElements())}).delegateTo(document,s.paginator),new m("multiRecordSelection:checkbox:state:changed",this.handleCheckboxStateChanged.bind(this)).bindTo(document),new m("multiRecordSelection:action:massundo",this.undoRecord.bind(this)).bindTo(document),new m("multiRecordSelection:action:massdelete",this.deleteRecord.bind(this)).bindTo(document)}initialize(){this.registerEvents(),TYPO3.settings.Recycler.depthSelection>0&&(document.querySelector(s.depthSelector).value=String(TYPO3.settings.Recycler.depthSelection)),this.loadAvailableTables().then(()=>{this.loadDeletedElements()})}handleCheckboxStateChanged(t){const e=t.target,l=e.closest("tr"),n=l.dataset.table,o=l.dataset.uid,a=n+":"+o;if(e.checked)this.markedRecordsForMassAction.push(a);else{const r=this.markedRecordsForMassAction.indexOf(a);r>-1&&this.markedRecordsForMassAction.splice(r,1)}if(this.markedRecordsForMassAction.length>0){const r=document.querySelector(s.massUndo);if(r.querySelector("span.text").textContent=i.get("button.undoselected",{0:this.markedRecordsForMassAction.length.toString(10)}),!TYPO3.settings.Recycler.deleteDisable){const c=document.querySelector(s.massDelete);c.querySelector("span.text").textContent=i.get("button.deleteselected",{0:this.markedRecordsForMassAction.length.toString(10)})}}else this.resetMassActionButtons()}resetMassActionButtons(){const t=document.querySelector(s.massUndo);if(this.markedRecordsForMassAction=[],t.querySelector("span.text").textContent=i.get("button.undo"),!TYPO3.settings.Recycler.deleteDisable){const e=document.querySelector(s.massDelete);e.querySelector("span.text").textContent=i.get("button.delete")}document.dispatchEvent(new CustomEvent("multiRecordSelection:actions:hide"))}async loadAvailableTables(){const t=document.querySelector(s.tableSelector),e=document.querySelector(s.depthSelector);return this.getProgress().start(),t.value="",this.paging.currentPage=1,new x(TYPO3.settings.ajaxUrls["recycler.getTables"]).withQueryArguments({startUid:TYPO3.settings.Recycler.startUid,depth:e.value,depthSelection:e.value}).get().then(async l=>{const n=await l.resolve(),o=[];t.replaceChildren();for(const a of n){const r=a[0],c=a[1],h=(a[2]?a[2]:i.get("label_allrecordtypes"))+" ("+c+")",g=document.createElement("option");g.value=r,g.textContent=h,o.push(g)}return o.length>0&&(t.append(...o),TYPO3.settings.Recycler.tableSelection!==""&&(t.value=TYPO3.settings.Recycler.tableSelection)),l}).finally(()=>{this.progressBar&&this.progressBar.done()})}async loadDeletedElements(){const t=document.querySelector(s.depthSelector),e=document.querySelector(s.tableSelector),l=document.querySelector(s.searchText);return this.getProgress().start(),this.resetMassActionButtons(),new x(TYPO3.settings.ajaxUrls["recycler.getDeletedRecords"]).withQueryArguments({depth:t.value,startUid:TYPO3.settings.Recycler.startUid,table:e.value,filterTxt:l.value,start:(this.paging.currentPage-1)*this.paging.itemsPerPage,limit:this.paging.itemsPerPage,depthSelection:t.value,tableSelection:e.value}).get().then(async n=>{const o=document.querySelector(s.recyclerTable),a=o.querySelector("tbody"),r=await n.resolve();if(r.totalItems===0){if(o.parentElement.querySelector("#no-recycler-records")===null){const c=document.createElement("typo3-backend-alert");c.id="no-recycler-records",c.severity=S.info,c.message=i.get("alert.noDeletedRecords"),c.showIcon=!0,o.parentElement.insertBefore(c,o)}}else o.parentElement.querySelector("#no-recycler-records")?.remove(),a.innerHTML=r.rows;return o.toggleAttribute("hidden",r.totalItems===0),this.buildPaginator(r.totalItems),n}).finally(()=>{this.progressBar&&this.progressBar.done()})}deleteRecord(t,e){if(TYPO3.settings.Recycler.deleteDisable)return;const n=(e||t.target).closest("tr"),o=n===null||n.parentElement.tagName!=="TBODY";let a,r;if(o)a=this.markedRecordsForMassAction,r=i.get("modal.massdelete.text");else{const c=n.dataset.uid,u=n.dataset.table,h=n.dataset.recordtitle;a=[u+":"+c];const g={0:h,1:"["+a[0]+"]"};r=u==="pages"?i.get("modal.deletepage.text",g):i.get("modal.deletecontent.text",g)}f.advanced({title:i.get("modal.delete.header"),content:r,severity:S.error,staticBackdrop:!0,buttons:[{text:R.get("cancel"),btnClass:"btn-default",trigger:function(){f.dismiss()}},{text:i.get("button.delete"),btnClass:"btn-danger",action:new T(()=>{this.callAjaxAction("delete",a,o)})}]})}undoRecord(t,e){const n=(e||t.target).closest("tr"),o=n===null||n.parentElement.tagName!=="TBODY";let a,r,c;if(o)a=this.markedRecordsForMassAction,r=i.get("modal.massundo.text"),c=!0;else{const h=n.dataset.uid,g=n.dataset.table,b=n.dataset.recordtitle;a=[g+":"+h],c=g==="pages";const p={0:b,1:"["+a[0]+"]"};r=c?i.get("modal.undopage.text",p):i.get("modal.undocontent.text",p),c&&n.dataset.parentDeleted&&(r+=i.get("modal.undo.parentpages"))}let u=null;if(c){const h=document.createElement("div"),g=document.createElement("p");g.textContent=r;const b=document.createElement("div");b.classList.add("form-check");const p=document.createElement("input");p.type="checkbox",p.id="undo-recursive",p.classList.add("form-check-input");const y=document.createElement("label");y.classList.add("form-check-label"),y.htmlFor="undo-recursive",y.textContent=i.get("modal.undo.recursive"),b.append(p,y),h.append(g,b),u=h}else{const h=document.createElement("p");h.textContent=r,u=h}f.advanced({title:i.get("modal.undo.header"),content:u,severity:S.ok,staticBackdrop:!0,buttons:[{text:R.get("cancel"),btnClass:"btn-default",trigger:function(){f.dismiss()}},{text:i.get("button.undo"),btnClass:"btn-success",action:new T(()=>{this.callAjaxAction("undo",typeof a=="object"?a:[a],o,u.querySelector("#undo-recursive")?.checked)})}]})}async callAjaxAction(t,e,l,n=!1){let o;const a={records:e};let r=!1;if(t==="undo")o=TYPO3.settings.ajaxUrls["recycler.undoRecords"],a.recursive=n?1:0,r=!0;else if(t==="delete")o=TYPO3.settings.ajaxUrls["recycler.deleteRecords"];else return null;return this.getProgress().start(),new x(o).post(a).then(async c=>{const u=await c.resolve();return u.success?P.success("",u.message):P.error("",u.message),this.paging.currentPage=1,this.loadAvailableTables().then(()=>{this.loadDeletedElements(),l&&this.resetMassActionButtons(),r&&v.refreshPageTree()}),c})}buildPaginator(t){const e=document.querySelector(s.paginator);if(t===0){e.replaceChildren();return}if(this.paging.totalItems=t,this.paging.totalPages=Math.ceil(t/this.paging.itemsPerPage),this.paging.totalPages===1){e.replaceChildren();return}const l=document.createElement("typo3-backend-pagination");l.paging=this.paging,e.replaceChildren(l)}}var k=new v;export{k as default};
